name: üöÄ Deploy Frontend (Universal)

on:
  push:
    branches: [main, staging, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/atijaguar-ec/fe-inatrace

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4

    - name: üîê Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}

    - name: üöÄ Deploy with Docker Compose
      run: |
        # Configurar variables para el compose
        export FE_IMAGE_NAME=${{ env.IMAGE_NAME }}
        export FE_TAG=${{ github.sha }}
        export CONTAINER_NAME=inatrace-fe-${{ github.ref_name }}
        export HOST_HTTP_PORT=8081
        export FRONTEND_NETWORK=inatrace-frontend-network
        export BACKEND_NETWORK=inatrace-backend-network
        export HEALTHCHECK_URL=http://localhost
        export HEALTHCHECK_INTERVAL=15s
        export HEALTHCHECK_TIMEOUT=5s
        export HEALTHCHECK_RETRIES=3
        export HEALTHCHECK_START_PERIOD=10s
        export NGINX_CONF_PATH=./nginx.conf

        # Crear redes si no existen
        docker network create $FRONTEND_NETWORK 2>/dev/null || true
        docker network create $BACKEND_NETWORK 2>/dev/null || true

        # Copiar nginx.conf al directorio ci
        cp nginx.conf ci/nginx.conf

        # Desplegar con compose
        docker-compose -f ci/docker-compose.yml pull
        docker-compose -f ci/docker-compose.yml up -d --force-recreate

        # Verificar healthcheck
        echo "‚è≥ Esperando healthcheck..."
        for i in {1..12}; do
          if curl -f http://localhost:8081 >/dev/null 2>&1; then
            echo "‚úÖ Frontend desplegado correctamente"
            docker-compose -f ci/docker-compose.yml ps
            exit 0
          fi
          echo "Intento $i/12 - Esperando 10s..."
          sleep 10
        done
        
        echo "‚ùå Healthcheck fall√≥"
        docker-compose -f ci/docker-compose.yml logs
        exit 1

    - name: üßπ Cleanup
      if: always()
      run: |
        docker logout ${{ env.REGISTRY }}
        docker image prune -f
