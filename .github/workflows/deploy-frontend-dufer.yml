# =============================================================================
# ðŸ¦ INATrace Frontend - DUFER Pipeline (CamarÃ³n)
# =============================================================================
# Autor: DevOps Team
# DescripciÃ³n: Pipeline CI/CD exclusivo para DUFER (Staging + Production)
# Producto: CamarÃ³n (Shrimp)
# Dominio Test: inatrace-test.empacadoradufer.com
# Dominio Prod: inatrace.empacadoradufer.com
# =============================================================================

name: ðŸ¦ DUFER Frontend (CamarÃ³n)

on:
  push:
    branches: [staging, main]
    paths:
      - 'src/**'
      - 'package*.json'
      - 'angular.json'
      - 'Dockerfile'
      - '.github/workflows/deploy-frontend-dufer.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente destino'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-inatrace
  NODE_VERSION: '14'
  SWAGGER_DOCS_HOST: https://inatrace.atijaguar.com/api/v3/api-docs
  # DUFER specific
  COMPANY_NAME: DUFER
  COMPANY_THEME: camaronera
  PRIMARY_PRODUCT_TYPE: SHRIMP

# =============================================================================
# JOBS
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # Quality Gate
  # ---------------------------------------------------------------------------
  quality:
    name: ðŸ” Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ðŸ§¹ Clean cache
        run: npm cache clean --force

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ” Lint
        run: npm run lint
        continue-on-error: true

      - name: ðŸ§ª Unit tests
        run: npm run test -- --watch=false --progress=false

  # ---------------------------------------------------------------------------
  # Build Docker Image
  # ---------------------------------------------------------------------------
  build:
    name: ðŸ—ï¸ Build Docker Image
    runs-on: ubuntu-latest
    needs: quality
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
      image-ref: ${{ steps.image_ref.outputs.image }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Generate tag
        id: meta
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            VERSION=$(grep -m1 '"version":' package.json | sed -E 's/.*"([0-9.]+)".*/\1/')
            TAG="dufer-v${VERSION}"
          else
            TAG="dufer-staging-${GITHUB_SHA::7}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "ðŸ·ï¸ Tag: $TAG"

      - name: ðŸ” Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Compute image ref
        id: image_ref
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          IMAGE=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”„ Generate API client
        run: npm run generate-api

      - name: ðŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.image_ref.outputs.image }}:${{ steps.meta.outputs.tag }}
            ${{ steps.image_ref.outputs.image }}:dufer-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: BUILD_OPTIMIZATION=true

  # ---------------------------------------------------------------------------
  # Deploy: DUFER Staging (Test)
  # ---------------------------------------------------------------------------
  deploy-staging:
    name: ðŸ§ª DUFER Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/staging' || github.event.inputs.environment == 'staging'
    environment:
      name: dufer-staging
      url: https://inatrace-test.empacadoradufer.com
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“ Prepare remote directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DUFER_HOST }}
          username: ${{ secrets.DUFER_USER }}
          key: ${{ secrets.DUFER_SSH_KEY }}
          port: ${{ secrets.DUFER_PORT || 22 }}
          script: mkdir -p /opt/inatrace/frontend/test/dufer

      - name: ðŸ“¤ Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DUFER_HOST }}
          username: ${{ secrets.DUFER_USER }}
          key: ${{ secrets.DUFER_SSH_KEY }}
          port: ${{ secrets.DUFER_PORT || 22 }}
          source: "ci/docker-compose.yml"
          target: "/opt/inatrace/frontend/test/dufer"
          strip_components: 1

      - name: ðŸ“¤ Upload nginx.conf
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DUFER_HOST }}
          username: ${{ secrets.DUFER_USER }}
          key: ${{ secrets.DUFER_SSH_KEY }}
          port: ${{ secrets.DUFER_PORT || 22 }}
          source: "nginx.conf"
          target: "/opt/inatrace/frontend/test/dufer"

      - name: ðŸ“ Prepare .env
        run: |
          cat > .env <<EOF
          IMAGE_NAME=${{ needs.build.outputs.image-ref }}
          TAG=${{ needs.build.outputs.image-tag }}
          NODE_ENV=test
          PRIMARY_PRODUCT_TYPE=${{ env.PRIMARY_PRODUCT_TYPE }}
          CONTAINER_NAME=inatrace-fe-test-dufer
          HOST_HTTP_PORT=8081
          FRONTEND_NETWORK=inatrace-frontend-dufer-network
          BACKEND_NETWORK=inatrace-backend-dufer-network
          DOMAIN=inatrace-test.empacadoradufer.com
          COMPANY_NAME=${{ env.COMPANY_NAME }}
          COMPANY_THEME=${{ env.COMPANY_THEME }}
          TRAEFIK_ENABLE=true
          TRAEFIK_ROUTER_NAME=inatrace-fe-test-dufer
          TRAEFIK_ROUTER_RULE=Host(\`inatrace-test.empacadoradufer.com\`)
          TRAEFIK_ENTRYPOINTS=websecure
          TRAEFIK_CERT_RESOLVER=letsencrypt
          EOF

      - name: ðŸ“¤ Upload .env
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DUFER_HOST }}
          username: ${{ secrets.DUFER_USER }}
          key: ${{ secrets.DUFER_SSH_KEY }}
          port: ${{ secrets.DUFER_PORT || 22 }}
          source: ".env"
          target: "/opt/inatrace/frontend/test/dufer"

      - name: ðŸš€ Deploy Staging
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DUFER_HOST }}
          username: ${{ secrets.DUFER_USER }}
          key: ${{ secrets.DUFER_SSH_KEY }}
          port: ${{ secrets.DUFER_PORT || 22 }}
          script: |
            set -e
            echo "ðŸ¦ Deploying DUFER Staging..."
            cd /opt/inatrace/frontend/test/dufer
            
            set -a && source .env && set +a
            
            # Networks
            docker network inspect inatrace-frontend-dufer-network >/dev/null 2>&1 || docker network create inatrace-frontend-dufer-network
            docker network inspect inatrace-backend-dufer-network >/dev/null 2>&1 || docker network create inatrace-backend-dufer-network
            
            # Deploy
            docker compose down 2>/dev/null || true
            docker compose pull
            docker compose up -d
            
            # Health check
            echo "â³ Health check..."
            for i in {1..12}; do
              sleep 10
              if curl -sf http://localhost:8081/health; then
                echo "âœ… DUFER Staging deployed successfully!"
                exit 0
              fi
              echo "  Attempt $i/12..."
            done
            
            echo "âŒ Health check failed"
            docker compose logs --tail=100
            exit 1

  # ---------------------------------------------------------------------------
  # Deploy: DUFER Production
  # ---------------------------------------------------------------------------
  deploy-production:
    name: ðŸ­ DUFER Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment:
      name: dufer-production
      url: https://inatrace.empacadoradufer.com
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“ Prepare remote directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DUFER_PROD_HOST }}
          username: ${{ secrets.DUFER_PROD_USER }}
          key: ${{ secrets.DUFER_PROD_SSH_KEY }}
          port: ${{ secrets.DUFER_PROD_PORT || 22 }}
          script: mkdir -p /opt/inatrace/frontend/prod/dufer

      - name: ðŸ“¤ Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DUFER_PROD_HOST }}
          username: ${{ secrets.DUFER_PROD_USER }}
          key: ${{ secrets.DUFER_PROD_SSH_KEY }}
          port: ${{ secrets.DUFER_PROD_PORT || 22 }}
          source: "ci/docker-compose.yml"
          target: "/opt/inatrace/frontend/prod/dufer"
          strip_components: 1

      - name: ðŸ“¤ Upload nginx.conf
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DUFER_PROD_HOST }}
          username: ${{ secrets.DUFER_PROD_USER }}
          key: ${{ secrets.DUFER_PROD_SSH_KEY }}
          port: ${{ secrets.DUFER_PROD_PORT || 22 }}
          source: "nginx.conf"
          target: "/opt/inatrace/frontend/prod/dufer"

      - name: ðŸ“ Prepare .env
        run: |
          cat > .env <<EOF
          IMAGE_NAME=${{ needs.build.outputs.image-ref }}
          TAG=${{ needs.build.outputs.image-tag }}
          NODE_ENV=production
          PRIMARY_PRODUCT_TYPE=${{ env.PRIMARY_PRODUCT_TYPE }}
          CONTAINER_NAME=inatrace-fe-prod-dufer
          HOST_HTTP_PORT=8081
          FRONTEND_NETWORK=inatrace-frontend-dufer-network
          BACKEND_NETWORK=inatrace-backend-dufer-network
          DOMAIN=inatrace.empacadoradufer.com
          COMPANY_NAME=${{ env.COMPANY_NAME }}
          COMPANY_THEME=${{ env.COMPANY_THEME }}
          TRAEFIK_ENABLE=true
          TRAEFIK_ROUTER_NAME=inatrace-fe-prod-dufer
          TRAEFIK_ROUTER_RULE=Host(\`inatrace.empacadoradufer.com\`)
          TRAEFIK_ENTRYPOINTS=websecure
          TRAEFIK_CERT_RESOLVER=letsencrypt
          EOF

      - name: ðŸ“¤ Upload .env
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DUFER_PROD_HOST }}
          username: ${{ secrets.DUFER_PROD_USER }}
          key: ${{ secrets.DUFER_PROD_SSH_KEY }}
          port: ${{ secrets.DUFER_PROD_PORT || 22 }}
          source: ".env"
          target: "/opt/inatrace/frontend/prod/dufer"

      - name: ðŸš€ Deploy Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DUFER_PROD_HOST }}
          username: ${{ secrets.DUFER_PROD_USER }}
          key: ${{ secrets.DUFER_PROD_SSH_KEY }}
          port: ${{ secrets.DUFER_PROD_PORT || 22 }}
          script: |
            set -e
            echo "ðŸ¦ Deploying DUFER Production..."
            cd /opt/inatrace/frontend/prod/dufer
            
            set -a && source .env && set +a
            
            # Networks
            docker network inspect inatrace-frontend-dufer-network >/dev/null 2>&1 || docker network create inatrace-frontend-dufer-network
            docker network inspect inatrace-backend-dufer-network >/dev/null 2>&1 || docker network create inatrace-backend-dufer-network
            
            # Deploy
            docker compose down 2>/dev/null || true
            docker compose pull
            docker compose up -d
            
            # Health check
            echo "â³ Health check..."
            for i in {1..12}; do
              sleep 10
              if curl -sf https://inatrace.empacadoradufer.com/health; then
                echo "âœ… DUFER Production deployed successfully!"
                exit 0
              fi
              echo "  Attempt $i/12..."
            done
            
            echo "âŒ Health check failed"
            docker compose logs --tail=100
            exit 1

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ¦ DUFER Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.deploy-staging.result }}" != "skipped" ]]; then
            echo "| ðŸ§ª Staging | ${{ needs.deploy-staging.result }} | https://inatrace-test.empacadoradufer.com |" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.deploy-production.result }}" != "skipped" ]]; then
            echo "| ðŸ­ Production | ${{ needs.deploy-production.result }} | https://inatrace.empacadoradufer.com |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Producto:** CamarÃ³n (SHRIMP)" >> $GITHUB_STEP_SUMMARY
          echo "**Empresa:** DUFER" >> $GITHUB_STEP_SUMMARY
