# Plantilla de jobs de despliegue frontend por empresa (staging + prod)
# Basada en fe/.github/workflows/deploy-frontend.yml
#
# Uso esperado:
# - Copiar estos jobs dentro del workflow real frontend de una empresa.
# - Reemplazar los placeholders:
#     {COMPANY_CODE}  -> c√≥digo en MAY√öSCULAS (ej.: DUFER)
#     {company_code}  -> c√≥digo en min√∫sculas (ej.: dufer)
#     {company-domain} -> dominio p√∫blico (ej.: empacadoradufer.com)
# - Asegurarse de tener definido el job build y env REGISTRY/IMAGE_NAME.

jobs:
  deploy-test-{company_code}:
    name: üß™ Deploy to {COMPANY_CODE} Test
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/staging'
    environment:
      name: test-{company_code}
      url: https://frontend-test.{company-domain}

    steps:
      - name: üì• Checkout deployment configs
        uses: actions/checkout@v4

      - name: üìÅ Ensure remote directory exists
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGE_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.STAGE_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.STAGE_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.STAGE_FE_{COMPANY_CODE}_PORT || '22' }}
          script: |
            mkdir -p /opt/inatrace/frontend/test/{company_code}

      - name: üì§ Upload docker-compose.yml
        if: ${{ hashFiles('ci/docker-compose.yml') != '' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGE_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.STAGE_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.STAGE_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.STAGE_FE_{COMPANY_CODE}_PORT || '22' }}
          source: "ci/docker-compose.yml"
          target: "/opt/inatrace/frontend/test/{company_code}"
          strip_components: 1

      - name: üì§ Upload nginx.conf
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGE_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.STAGE_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.STAGE_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.STAGE_FE_{COMPANY_CODE}_PORT || '22' }}
          source: "nginx.conf"
          target: "/opt/inatrace/frontend/test/{company_code}"

      - name: üìù Prepare .env ({COMPANY_CODE} test)
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"; IMAGE=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          TAG_VALUE="${{ needs.build.outputs.image-tag }}"
          cat > .env <<EOF
          IMAGE_NAME=$IMAGE
          TAG=$TAG_VALUE
          NODE_ENV=test
          COMPANY_NAME={COMPANY_CODE}
          COMPANY_THEME=cacao
          DOMAIN=frontend-test.{company-domain}
          PRIMARY_PRODUCT_TYPE=${{ env.PRIMARY_PRODUCT_TYPE }}
          CONTAINER_NAME=inatrace-fe-test-{company_code}
          HOST_HTTP_PORT=8081
          FRONTEND_NETWORK=inatrace-frontend-{company_code}-network
          BACKEND_NETWORK=inatrace-backend-{company_code}-network
          TRAEFIK_ENABLE=true
          TRAEFIK_ROUTER_NAME=inatrace-fe-test-{company_code}
          TRAEFIK_ROUTER_RULE=Host(`frontend-test.{company-domain}`)
          TRAEFIK_ENTRYPOINTS=websecure
          TRAEFIK_CERT_RESOLVER=letsencrypt
          HEALTHCHECK_URL=http://localhost:8081/health
          NGINX_CONF_PATH=./nginx.conf
          EOF

      - name: üì§ Upload .env ({COMPANY_CODE} test)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGE_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.STAGE_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.STAGE_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.STAGE_FE_{COMPANY_CODE}_PORT || '22' }}
          source: ".env"
          target: "/opt/inatrace/frontend/test/{company_code}"

      - name: üß™ Deploy to {COMPANY_CODE} Test
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGE_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.STAGE_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.STAGE_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.STAGE_FE_{COMPANY_CODE}_PORT || '22' }}
          script: |
            set -e
            echo "üß™ Starting deployment to {COMPANY_CODE} Test..."

            cd /opt/inatrace/frontend/test/{company_code}

            # Ensure required networks exist
            FRONTEND_NETWORK=$(grep '^FRONTEND_NETWORK=' .env | cut -d '=' -f2-)
            FRONTEND_NETWORK=${FRONTEND_NETWORK:-inatrace-frontend-{company_code}-network}
            BACKEND_NETWORK=$(grep '^BACKEND_NETWORK=' .env | cut -d '=' -f2-)
            BACKEND_NETWORK=${BACKEND_NETWORK:-inatrace-backend-{company_code}-network}
            docker network inspect "$FRONTEND_NETWORK" >/dev/null 2>&1 || docker network create "$FRONTEND_NETWORK"
            docker network inspect "$BACKEND_NETWORK" >/dev/null 2>&1 || docker network create "$BACKEND_NETWORK"

            docker compose down 2>/dev/null || true
            docker compose pull
            docker compose up -d --remove-orphans

            echo "‚è≥ Waiting for {COMPANY_CODE} test health endpoint..."
            for i in {1..10}; do
              sleep 10
              if curl -f "http://localhost:8081/health"; then
                echo "‚úÖ Deployment to {COMPANY_CODE} Test successful!"
                exit 0
              fi
              echo "‚è≥ Health check attempt $i/10 failed, retrying..."
            done

            echo "‚ùå Health check failed for {COMPANY_CODE} Test"
            docker compose logs --tail=100
            exit 1


  deploy-prod-{company_code}:
    name: üè≠ Deploy to {COMPANY_CODE} Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: prod-{company_code}
      url: https://frontend.{company-domain}

    steps:
      - name: üì• Checkout deployment configs
        uses: actions/checkout@v4

      - name: üìÅ Ensure remote directory exists
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.PROD_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.PROD_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.PROD_FE_{COMPANY_CODE}_PORT || '22' }}
          script: |
            mkdir -p /opt/inatrace/frontend/prod/{company_code}

      - name: üîç Verify local compose path (prod {COMPANY_CODE})
        run: |
          set -e
          ls -lah deploy/frontend/prod/{company_code} || true
          if [ ! -f deploy/frontend/prod/{company_code}/docker-compose.yml ]; then
            echo "Missing deploy/frontend/prod/{company_code}/docker-compose.yml"
            exit 1
          fi

      - name: üì• Download image artifact (prod {COMPANY_CODE})
        uses: actions/download-artifact@v4
        with:
          name: fe-image
          path: .

      - name: üì§ Upload docker-compose.yml (prod {COMPANY_CODE})
        if: ${{ hashFiles('deploy/frontend/prod/{company_code}/docker-compose.yml') != '' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.PROD_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.PROD_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.PROD_FE_{COMPANY_CODE}_PORT || '22' }}
          source: "deploy/frontend/prod/{company_code}/docker-compose.yml"
          target: "/opt/inatrace/frontend/prod/{company_code}"

      - name: üì§ Upload image tar (prod {COMPANY_CODE})
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.PROD_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.PROD_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.PROD_FE_{COMPANY_CODE}_PORT || '22' }}
          source: "image.tar"
          target: "/opt/inatrace/frontend/prod/{company_code}"

      - name: üìù Prepare .env (prod {COMPANY_CODE})
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"; IMAGE=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          TAG_VALUE="${{ needs.build.outputs.image-tag }}"
          cat > .env <<EOF
          IMAGE_NAME=$IMAGE
          TAG=$TAG_VALUE
          NODE_ENV=production
          API_BASE_URL=http://inatrace-be-{company_code}:8080
          COMPANY_NAME={COMPANY_CODE}
          COMPANY_THEME=cacao
          DOMAIN=frontend.{company-domain}
          EOF

      - name: üì§ Upload .env (prod {COMPANY_CODE})
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.PROD_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.PROD_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.PROD_FE_{COMPANY_CODE}_PORT || '22' }}
          source: ".env"
          target: "/opt/inatrace/frontend/prod/{company_code}"

      - name: üè≠ Deploy to {COMPANY_CODE} Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_FE_{COMPANY_CODE}_HOST }}
          username: ${{ secrets.PROD_FE_{COMPANY_CODE}_USER }}
          key: ${{ secrets.PROD_FE_{COMPANY_CODE}_SSH_KEY }}
          port: ${{ secrets.PROD_FE_{COMPANY_CODE}_PORT || '22' }}
          script: |
            set -e
            echo "üè≠ Starting deployment to {COMPANY_CODE} Production..."

            cd /opt/inatrace/frontend/prod/{company_code}

            docker compose down 2>/dev/null || true
            docker compose pull || true
            docker compose up -d --remove-orphans

            echo "‚è≥ Waiting for {COMPANY_CODE} prod health endpoint..."
            for i in {1..10}; do
              sleep 10
              if curl -f "http://localhost:8081/health"; then
                echo "‚úÖ Deployment to {COMPANY_CODE} Production successful!"
                exit 0
              fi
              echo "‚è≥ Health check attempt $i/10 failed, retrying..."
            done

            echo "‚ùå Health check failed for {COMPANY_CODE} Production"
            docker compose logs --tail=100
            exit 1
