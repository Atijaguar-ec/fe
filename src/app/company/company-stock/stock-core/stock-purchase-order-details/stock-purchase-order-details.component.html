<app-authorised-layout>
  <div *ngIf="stockOrderForm"  class="af-layout--authorised">

    <ng-container *ngIf="!orderType">
      <div class="af-form-wrapper">
        <single-choice
                label="Order type is not set for this order. Please set one."
                i18n-label="@@productLabelStockPurchaseOrdersModal.orderType.select.label"
                [formControlInput]="orderTypeForm"
                (onChange)="onSelectedType($event)"
                [codebookService]="orderTypeCodebook">
        </single-choice>
      </div>
    </ng-container>

    <div class="af-form-wrapper" *ngIf="orderType">

      <div class="af-form-row">
        <div class="af-form-block--c12 d-flex justify-content-between">
          <div class="title-page content-element--title">{{ title }} <span>{{ stockOrderForm.get('identifier').value }}</span></div>
          <app-last-seen-tag *ngIf="this.update"
                             [dateFormat]="stockOrderForm.get('lastChange').value"
                             [identifier]="userLastChanged">
          </app-last-seen-tag>
        </div>
      </div>

      <div class="af-form-row">

        <!-- First block in first row -->
        <div class="af-form-block--c6">

          <div>
            <h2 i18n="@@productLabelStockPurchaseOrdersModal.section.basicInfo">Basic information</h2>
          </div>

          <div class="af-form-element">
            <div class="af-row">
              <div class="af-c4">
                <app-datepicker
                        label="Delivery date"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.datepicker.date.label"
                        [form]="stockOrderForm.get('productionDate')"
                        [invalid]="submitted && stockOrderForm.get('productionDate').invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="stockOrderForm.get('productionDate').errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockPurchaseOrdersModal.datepicker.date.error">
                        Delivery date is required
                      </div>
                    </div>
                  </ng-container>
                </app-datepicker>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c9">
                <single-choice
                        label="Farmer"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.singleChoice.farmer"
                        [formControlInput]="searchFarmers"
                        [codebookService]="farmersCodebook"
                        (onChange)="setFarmer($event)"
                        style="min-width: 150px;"
                        [isInvalidChoice]="submitted && searchFarmers.invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="searchFarmers.errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockPurchaseOrdersModal.singleChoice.farmer.error">
                        Farmer is required
                      </div>
                    </div>
                  </ng-container>
                </single-choice>
              </div>
              <div class="af-c3 mt-4">
                <button class="btn btn--el" type="button" [disabled]="true"
                        i18n="@@productLabelStockPurchaseOrdersModal.button.farmer.qrCode"><span>QR code</span></button>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c9">
                <single-choice
                        label="Collector"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.singleChoice.collector"
                        [formControlInput]="searchCollectors"
                        [codebookService]="collectorsCodebook"
                        (onChange)="setCollector($event)"
                        style="min-width: 150px;">
                </single-choice>
              </div>
              <div class="af-c3 mt-4">
                <button class="btn btn--el" type="button" [disabled]="true"
                        i18n="@@productLabelStockPurchaseOrdersModal.button.collector.qrCode"><span>QR code</span></button>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c12">
                <textinput [form]="facilityNameForm"
                           label="Facility name"
                           style="width: 100%"
                           placeholder="Enter facility name"
                           i18n-label="@@productLabelStockPurchaseOrdersModal.textinput.facilityName.label"
                           i18n-placeholder="@@productLabelStockPurchaseOrdersModal.textinput.facilityName.placeholder"
                           [readOnly]=true>
                </textinput>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c12">
                <single-choice
                        label="Cooperative employee"
                        i18n-label="Cooperative employee"
                        [formControlInput]="employeeForm"
                        [codebookService]="codebookUsers"
                        style="min-width: 150px;"
                        [isInvalidChoice]="submitted && employeeForm.invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="employeeForm.errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockPurchaseOrdersModal.singleChoice.farmer.error">
                        Cooperative employee is required
                      </div>
                    </div>
                  </ng-container>
                </single-choice>
              </div>
            </div>
          </div>
        </div>

        <!-- Second block in first row -->
        <div class="af-form-block--c6">

          <h2 i18n="@@productLabelStockPurchaseOrdersModal.section.purchaseDetails">Purchase details</h2>

          <div class="af-form-element">

            <div class="af-row">
              <div class="af-c12">
                <div class="form-group">
                  <label class="d-flex mb-0 text-input-label"
                         i18n="@@productLabelStockPurchaseOrdersModal.singleChoice.semiProduct">Semi-product<span>*</span></label>
                  <ng-select bindLabel="name"
                             bindValue="id"
                             placeholder="Select semi-product"
                             (ngModelChange)="semiProductSelected($event)"
                             i18n-placeholder="@@productLabelStockPurchaseOrdersModal.singleChoice.semiProduct.placeholder"
                             [items]="options"
                             [(ngModel)]="modelChoice"
                             notFoundText="Nothing found"
                             i18-notFoundText="@@productLabelStockPurchaseOrdersModal.singleChoice.semiProduct.nothing"
                             i18-typeToSearchText="@@productLabelStockPurchaseOrdersModal.singleChoice.semiProduct.enterSearchTerm"
                             typeToSearchText="Enter search term"
                             class="custom labelPlaceholder"
                             style="border:none">
                  </ng-select>
                </div>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c6">
                <textinput
                        [form]="stockOrderForm.get('totalQuantity')"
                        [label]="quantityLabel"
                        style="width: 100%"
                        placeholder="Enter quantity"
                        i18n-placeholder="@@productLabelStockPurchaseOrdersModal.textinput.quantityDelieveredInKG.placeholder"
                        [isInvalid]="submitted && stockOrderForm.get('totalQuantity').invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="stockOrderForm.get('totalQuantity').errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockPurchaseOrdersModal.quantityDelieveredInKG.textinput.quantityDelieveredInKG.error">
                        Quantity is required
                      </div>
                    </div>
                  </ng-container>
                </textinput>
              </div>

              <div class="af-c6">
                <textinput
                        type="number"
                        min="0"
                        step="0.01"
                        [form]="stockOrderForm.get('pricePerUnit')"
                        label="Price per unit (RWF/kg)"
                        style="width: 100%"
                        placeholder="Enter price per unit"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.textinput.pricePerUnit.label"
                        i18n-placeholder="@@productLabelStockPurchaseOrdersModal.textinput.pricePerUnit.placeholder"
                        [isInvalid]="submitted && stockOrderForm.get('pricePerUnit').invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="stockOrderForm.get('pricePerUnit').errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockPurchaseOrdersModal.unityPrice.textinput.unityPrice.error">
                        Price per unit is required
                      </div>
                    </div>
                  </ng-container>
                </textinput>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c6">
                <textinput
                        [form]="stockOrderForm.get('cost')"
                        label="Payable 1st installment (RWF)"
                        style="width: 100%"
                        placeholder="Payable 1st installment"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.textinput.cost.label"
                        i18n-placeholder="@@productLabelStockPurchaseOrdersModal.textinput.cost.placeholder"
                        [value]="setToBePaid()"
                        [readOnly]=true>
                </textinput>
              </div>

              <div class="af-c6">
                <textinput
                        [form]="stockOrderForm.get('balance')"
                        label="Open balance (RWF)"
                        style="width: 100%"
                        placeholder="Open balance"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.textinput.balance.label"
                        i18n-placeholder="@@productLabelStockPurchaseOrdersModal.textinput.balance.placeholder"
                        [value]="setBalance()"
                        [readOnly]=true>
                </textinput>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c12">
                <single-choice
                        label="Preferred way of payment"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.singleChoice.preferredWayOfPayment"
                        [formControlInput]="stockOrderForm.get('preferredWayOfPayment')"
                        [codebookService]="codebookPreferredWayOfPayment"
                        style="min-width: 150px;"
                        [isInvalidChoice]="submitted && stockOrderForm.get('preferredWayOfPayment').invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="stockOrderForm.get('preferredWayOfPayment').errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockPurchaseOrdersModal.singleChoice.preferredWayOfPayment.error">
                        Preferred way of payment is required
                      </div>
                    </div>
                  </ng-container>
                </single-choice>
              </div>
            </div>

            <div class="af-row">
              <div class="af-c12">
                <single-choice
                        label="Women’s only"
                        i18n-label="@@productLabelStockPurchaseOrdersModal.singleChoice.womensOnly"
                        [formControlInput]="searchWomenCoffeeForm"
                        [codebookService]="codebookWomenCoffee"
                        style="min-width: 150px;"
                        [isInvalidChoice]="submitted && searchWomenCoffeeForm.invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="searchWomenCoffeeForm.errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockPurchaseOrdersModal.singleChoice.womensOnly.error">
                        Women’s only is required
                      </div>
                    </div>
                  </ng-container>
                </single-choice>
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- TODO: -->

      <div class="af-form-row">
        <div class="af-form-block--c12">

          <div class="af-bottom-buttons" i18n="@@productLabelStockPurchaseOrdersModal.modal.footer.buttons">
            <button class="btn btn-outlined mr-2" data-dismiss="modal" type="button" (click)="dismiss()"><span>Cancel</span></button>
            <button class="btn mr-2" type="button" (click)="!this.updatePOInProgress && updatePurchaseOrder(!this.update)"><span>Save</span></button>
            <button *ngIf="this.update" class="btn" type="button" (click)="!this.updatePOInProgress && updatePurchaseOrder()"><span>Save & Close</span></button>
          </div>

        </div>
      </div>

    </div>

  </div>
</app-authorised-layout>
