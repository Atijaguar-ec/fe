<app-authorised-layout>
  <div *ngIf="form" class="af-layout--authorised">

    <div class="af-form-wrapper">

      <div class="af-form-row">
        <div class="af-form-block--c12 d-flex justify-content-between">
          <div class="title-page content-element--title">{{ title }}<span></span></div>
        </div>
      </div>

      <!-- row 1 -->
      <div class="af-form-row">

        <!-- row 1, col 1 -->
        <!-- PROCESSING ACTION SELECTION DROPDOWN -->
        <div class="af-form-block--c6">
          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.processing">Choose activity that you want to record</h2>
          <div class="af-form-element">

            <div class="af-row">
              <div class="af-c12">
                <single-choice
                        label="Processing"
                        i18n-label="@@productLabelStockProcessingOrderDetail.processingActionForm.label"
                        [formControlInput]="processingActionForm"
                        [codebookService]="activeProcessingCodebook"
                        style="min-width: 150px;"
                        (onChange)="setProcessingAction($event)"
                        [isInvalidChoice]="submitted && processingActionForm.invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="processingActionForm.errors as errors" class="sc-invalid-feedback"
                         i18n="@@productLabelStockProcessingOrderDetail.processingActionForm.error">
                      Action is required
                    </div>
                  </ng-container>
                </single-choice>
              </div>
            </div>

            <div class="af-row" *ngIf="actionType === 'GENERATE_QR_CODE'">
              <div class="af-c12">
                <textinput
                        [form]="qrCodeForFinalProductForm"
                        label="QR code for final product"
                        i18n-label="@@productLabelStockProcessingOrderDetail.qrCodeForFinalProduct.label"
                        style="width: 100%"
                        [readOnly]="true">
                </textinput>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- row 2 -->
      <div class="af-form-row">

        <!-- row 2, col 1 -->
        <div class="af-form-block--c6">
          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.input">Material to be recorded</h2>

          <div class="af-form-element" style="position: relative;">
            <ng-container *ngIf="this.prAction">

              <div class="af-row mb-3" *ngIf="actionType === 'SHIPMENT'">
                <div class="af-c12">
                  {{ inputFacilityForm?.value?.company?.name }}
                </div>
              </div>

              <!-- INPUT FACILITY SELECTION DROPDOWN -->
              <div class="af-row">
                <div class="af-c12">
                  <single-choice
                          *ngIf="inputFacilitiesCodebook"
                          label="Facility"
                          i18n-label="@@productLabelStockProcessingOrderDetail.inputFacilityForm.label"
                          [formControlInput]="inputFacilityForm"
                          [codebookService]="inputFacilitiesCodebook"
                          style="min-width: 150px;"
                          (onChange)="setInputFacility($event)"
                          [isInvalidChoice]="submitted && inputFacilityForm.invalid">
                    <ng-container *ngIf="submitted">
                      <div *ngIf="inputFacilityForm.errors as errors" class="sc-invalid-feedback" i18n="@@productLabelStockProcessingOrderDetail.inputFacilityForm.error">
                        Input facility is required
                      </div>
                    </ng-container>
                  </single-choice>
                </div>
              </div>

              <!-- FILTERS FOR AVAILABLE STOCK AT SELECTED FACILITY FOR THE SELECTED SEMI-PRODUCT -->
              <div *ngIf="showInputTransactions" class="d-flex justify-content-between"
                   style="margin-bottom: 1rem;" ngbDropdown placement="bottom-right" display="dynamic" container="body">

                <div class="af-row">
                  <div class="af-c12">
                    <div class="d-flex">

                      <app-datepicker
                              label="From"
                              i18n-label="@@productLabelStockProcessingOrderDetail.datepicker.date.from"
                              [form]="fromFilterDate"
                              [invalid]="submitted && fromFilterDate.invalid"
                              style="width: 130px; margin-right: 1rem;"
                              (onChange)="dateSearch()">
                        <ng-container>
                          <div *ngIf="fromFilterDate.errors as errors" class="sc-invalid-feedback">
                            <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.date.error">
                              Delivery date is required
                            </div>
                          </div>
                        </ng-container>
                      </app-datepicker>

                      <app-datepicker
                              label="To"
                              i18n-label="@@productLabelStockProcessingOrderDetail.datepicker.date.to"
                              [form]="toFilterDate"
                              [invalid]="submitted && toFilterDate.invalid"
                              style="width: 130px"
                              (onChange)="dateSearch()">
                        <ng-container>
                          <div *ngIf="toFilterDate.errors as errors" class="sc-invalid-feedback">
                            <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.date.error">
                              Delivery date is required
                            </div>
                          </div>
                        </ng-container>
                      </app-datepicker>

                    </div>
                  </div>
                </div>

                <div class="d-flex" *ngIf="showWomensFilter">
                  <div *ngIf="womensOnlyStatus.value != null" class="d-flex filter-text" style="margin-left: 0.25rem; margin-top: 2rem"> {{ womensOnlyStatusValue }}
                    <div (click)="setWomensOnlyStatus(null)" style="margin-left: 0.5rem;">
                      <fa-icon style="cursor: pointer;" [icon]="faTimes" size="xs">
                      </fa-icon>
                    </div>
                  </div>

                  <button ngbDropdownToggle class="btn btn-filter" style="margin-left: 1rem; margin-top: 1.75rem; border-width: 1px;">
                    <span class="button-icon">
                      <span class="button-icon-shape button-icon-shape--filter"></span>
                    </span>
                    <span i18n="@@productLabelStockProcessingOrderDetail.filter" class="button-icon-label">Filter</span>
                  </button>

                  <div class="dropdown-menu" ngbDropdownMenu>
                    <button ngbDropdownItem (click)="setWomensOnlyStatus(true)" i18n="@@productLabelStockProcessingOrderDetail.filter.womensOnlyCoffee">Womens only coffee</button>
                    <button ngbDropdownItem (click)="setWomensOnlyStatus(false)" i18n="@@productLabelStockProcessingOrderDetail.filter.nonWomensOnlyCoffee">Non-womens only coffee</button>
                  </div>
                </div>

              </div>

              <!-- EXISTING INPUT TRANSACTIONS AND AVAIALBLE STOCK ORDERS THAT CAN BE ADDED TO THIS PROECSSING ORDER -->
              <div *ngIf="showInputTransactions" style="position: relative;">

                <div class="af-row">
                  <div class="af-c12">
                    <ng-container *ngIf="inputTransactions && inputTransactions.length">
                      <label class="ml-1">Existing transactions</label>
                      <div *ngFor="let tx of inputTransactions; index as i" class="af-row pb-2">
                        <ng-container *ngIf="inputStockOrders[i] as inputStockOrder">
                          <div class="af-c9 pl-3">
                            <div>
                              <span>{{ inputStockOrder.lotPrefix }} {{ inputStockOrder.identifier }} {{ inputStockOrder.internalLotNumber }} ({{ tx.status }})</span>
                              <span *ngIf="inputStockOrder.qrCodeTag"
                                    (click)="openInputStockOrderQRCode(inputStockOrder)"
                                    class="cursor-pointer">
                                <fa-icon [icon]="faQrcode" class="sorter-icon pl-2"></fa-icon>
                              </span>
                            </div>
                            <div *ngIf="tx.status === 'CANCELED'" class="canceled">{{ tx.rejectComment }}</div>
                          </div>
                          <div class="af-c2 text-right">{{ tx.outputQuantity }} {{ tx.inputMeasureUnitType?.label }}</div>

                          <div class="af-c1 text-right"
                               [hidden]="tx.status !== 'PENDING'"
                               (click)="deleteTransaction(i)">
                            <fa-icon
                                    class="del-icon cursor-pointer"
                                    [icon]="faTimes"></fa-icon>
                          </div>
                        </ng-container>
                      </div>
                    </ng-container>
                  </div>
                </div>

                <!-- CHECKBOX FOR SELECTING ALL INPUT AVAILABLE STOCK ORDERS -->
                <div class="af-row" *ngIf="inputFacilityForm.value && nonOutputStockOrdersInputStockOrdersLength > 0">
                  <label i18n="@@productLabelStockProcessingOrderDetail.addNewTransactions" class="ml-1 mt-2">Add new transactions</label>
                  <div class="af-c12" style="margin-top: -1rem;">
                    <checkbox-input (onClick)="selectAll()" [form]="cbSelectAllForm" [disabled]="disabledLeftFields" style="margin-bottom: 1rem; margin-top: -1rem;">
                      <checkbox-input-rich-label i18n="@@productLabelStockProcessingOrderDetail.checkbox.selectAll">
                        Select all ({{ currentInputStockUnitProduct.name }})
                      </checkbox-input-rich-label>
                    </checkbox-input>
                  </div>
                </div>

                <div class="af-row" *ngIf="inputFacilityForm.value && nonOutputStockOrdersInputStockOrdersLength == 0">
                  <label class="ml-1 mt-2" i18n="@@productLabelStockProcessingOrderDetail.noStock">No relevant stock to add transactions in facility</label>
                </div>

                <!-- LIST OF AVAILABLE STOCK ORDERS TO BE USED IN THE PROCESSING ACTION -->
                <ng-container *ngFor="let item of availableStockOrders; index as i">
                  <div class="af-row" *ngIf="!isOutputStockOrder(item)">
                    <div class="af-c1">
                      <checkbox-input inTable="true" (onClick)="cbSelected(item, i)" [disabled]="disabledLeftFields"
                                      [checked]="this.availableStockOrders[i].selected"></checkbox-input>
                    </div>
                    <div class="af-c8">
                      <ng-container *ngIf="item.orderType === 'PURCHASE_ORDER'">
                        <span>{{ item.identifier }} ({{ item.producerUserCustomer.name }} {{ item.producerUserCustomer.surname }})</span>
                      </ng-container>
                      <ng-container *ngIf="item.orderType != 'PURCHASE_ORDER'">
                        <span>{{ item.lotPrefix }} {{ item.identifier }} {{ item.internalLotNumber }}</span>
                        <span *ngIf="item.qrCodeTag"
                              (click)="openInputStockOrderQRCode(item)"
                              class="cursor-pointer">
                          <fa-icon [icon]="faQrcode" class="sorter-icon pl-2"></fa-icon>
                        </span>
                      </ng-container>
                      <span *ngIf="item.organic">
                        <fa-icon [icon]="faLeaf" class="sorter-icon pl-2" title="Organic coffee"
                                 i18n-title="@@productLabelStockProcessingOrderDetail.icon.organicCoffee.title"></fa-icon>
                      </span>
                      <span *ngIf="item.womenShare">
                        <fa-icon [icon]="faFemale" class="sorter-icon pl-2" title="Women's coffee"
                                 i18n-title="@@productLabelStockProcessingOrderDetail.icon.womensCoffee.title"></fa-icon>
                      </span>
                    </div>
                    <div class="af-c3 text-right">
                      <span *ngIf="actionType === 'PROCESSING' || actionType === 'FINAL_PROCESSING'"
                            (click)="clipInputTransaction(item, i)" class="cursor-pointer">
                        <fa-icon [icon]="faCut" class="pr-2"></fa-icon>
                      </span>
                      <span *ngIf="item.selected">{{ item.selectedQuantity }} / </span>{{ item.availableQuantity }} {{ currentInputStockUnitProduct.measurementUnitType.label }}
                    </div>
                  </div>
                </ng-container>

                <ng-container *ngIf="inputQuantityOrOutputFacilityNotSet">
                  <small class="sc-invalid-feedback" i18n="@@productLabelStockProcessingOrderDetail.inputQuantityOrOutputFacilityNotSet.error">
                    Set output quantity first
                  </small>
                </ng-container>

                <ng-container *ngIf="submitted && oneInputStockOrderRequired">
                  <small class="sc-invalid-feedback" i18n="@@productLabelStockProcessingOrderDetail.inputSemiProducts.error">
                    At least one input semi-product is required
                  </small>
                </ng-container>
                <div *ngIf="inputQuantityOrOutputFacilityNotSet" style="position: absolute; top:0; bottom: 0; left: 0; right: 0; background-color: white; opacity: 0.5;"></div>
              </div>

              <!-- TODO: check and rethink this -->
<!--              <ng-container *ngIf="this.prAction && this.prAction.requiredEvidenceFields">-->
<!--                <app-stock-processing-order-fields-->
<!--                        *ngFor="let fieldInfo of this.prAction.requiredEvidenceFields"-->
<!--                        side="left"-->
<!--                        [disabled]="disabledLeftFields"-->
<!--                        [isQuote]="actionType === 'SHIPMENT'"-->
<!--                        [fieldInfo]="fieldInfo"-->
<!--                        [formGroup]="outputStockOrderForm"-->
<!--                        [submitted]="submitted">-->
<!--                </app-stock-processing-order-fields>-->
<!--              </ng-container>-->

              <div *ngIf="!showLeftSide" style="position: absolute; top:0; bottom: 0; left: 0; right: 0; background-color: white; opacity: 0.5;"></div>

            </ng-container>
          </div>
        </div>

        <!-- row 2, col 2 -->
        <div class="af-form-block--c6">
          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.output">Results of recording</h2>

          <div class="af-form-element" style="position: relative;">
            <ng-container *ngIf="this.prAction">

              <div class="af-row mb-3" *ngIf="actionType === 'SHIPMENT'">
                <div class="af-c12">
                  {{ outputFacilityForm?.value?.company?.name }}
                </div>
              </div>

              <div class="af-row mb-3" *ngIf="actionType === 'SHIPMENT' && productOrderId">
                <div class="af-c12">
                  <span i18n="@@productLabelStockProcessingOrderDetail.orderID.label">Order ID:</span> {{ productOrderId }}
                </div>
              </div>

              <!-- THE OUTPUT FACILITY -->
              <div class="af-row">
                <div class="af-c12">
                  <single-choice
                          *ngIf="outputFacilitiesCodebook"
                          label="Facility"
                          i18n-label="@@productLabelStockProcessingOrderDetail.outputFacilityForm.label"
                          [formControlInput]="outputFacilityForm"
                          [codebookService]="outputFacilitiesCodebook"
                          style="min-width: 150px;"
                          (onChange)="setOutputFacility($event, false)"
                          [isInvalidChoice]="submitted && outputFacilityForm.invalid">
                    <ng-container *ngIf="submitted">
                      <div *ngIf="outputFacilityForm.errors as errors" class="sc-invalid-feedback" i18n="@@productLabelStockProcessingOrderDetail.outputFacilityForm.error">
                        Output facility is required
                      </div>
                    </ng-container>
                  </single-choice>
                </div>
              </div>

              <!-- THE INTERNAL LOT NUMBER -->
              <div class="af-row">
                <div class="af-c2">
                  <textinput
                          [form]="processingActionLotPrefixForm"
                          label="Prefix"
                          style="width: 100%"
                          i18n-label="@@productLabelStockProcessingOrderDetail.textinput.lotPrefix.label">
                  </textinput>
                </div>
                <div class="af-c10">
                  <textinput
                          [form]="outputStockOrderForm.get('internalLotNumber')"
                          label="Internal lot name"
                          style="width: 100%"
                          placeholder="Enter internal lot name"
                          i18n-label="@@productLabelStockProcessingOrderDetail.textinput.internalLotNumber.label"
                          i18n-placeholder="@@productLabelStockProcessingOrderDetail.textinput.internalLotNumber.placeholder"
                          [isInvalid]="submitted && outputStockOrderForm.get('internalLotNumber').invalid">
                    <ng-container *ngIf="submitted">
                      <div *ngIf="outputStockOrderForm.get('internalLotNumber').errors as errors" class="sc-invalid-feedback">
                        <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.internalLotNumber.textinput.error">
                          Internal lot name is required
                        </div>
                      </div>
                    </ng-container>
                  </textinput>
                </div>
              </div>

              <div class="af-row">
                <div class="af-c12">
                  <app-datepicker
                          label="Processing date"
                          i18n-label="@@productLabelStockProcessingOrderDetail.datepicker.date.processingDate"
                          [form]="processingDateForm"
                          [invalid]="submitted && processingDateForm.invalid"
                          style="width: 130px; margin-right: 1rem;">
                    <ng-container>
                      <div *ngIf="processingDateForm.errors as errors" class="sc-invalid-feedback">
                        <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.processingDate.error">
                          Processing date is required
                        </div>
                      </div>
                    </ng-container>
                  </app-datepicker>
                </div>
              </div>

              <!-- THE OUTPUT STOCK UNIT -->
              <div class="af-row">
                <div class="af-c12">
                  <textinput
                          [form]="currentOutputStockUnitNameForm"
                          [label]="outputStockUnitLabel"
                          style="width: 100%"
                          [readOnly]="true">
                  </textinput>
                </div>
              </div>

              <div class="af-row">
                <div class="af-c6 d-flex">
                  <textinput
                          [form]="form.get('outputQuantity')"
                          [label]="inputQuantityLabel"
                          style="width: 100%"
                          placeholder="Enter quantity"
                          i18n-placeholder="@@productLabelStockProcessingOrderDetail.textinput.inputQuantity.placeholder"
                          [readOnly]="true">
                  </textinput>
                </div>

                <div class="af-c6" *ngIf="showRemainingForm">
                  <textinput
                          [form]="remainingForm"
                          label="Remaining"
                          style="width: 100%"
                          i18n-label="@@productLabelStockProcessingOrderDetail.textinput.remaining.label"
                          [value]="setRemaining()"
                          [readOnly]=true>
                  </textinput>
                </div>
              </div>

              <!-- FORM CONTROLS FOR DEFINING OUTPUT QUANTITY -->
              <div class="af-row" *ngIf="showTotalQuantityForm">
                <div class="af-c6">
                  <textinput
                          [form]="outputStockOrderForm.get('totalQuantity')"
                          [label]="outputQuantityLabel"
                          [helpText]="expectedOutputQuantityHelpText"
                          style="width: 100%"
                          placeholder="Enter quantity"
                          i18n-placeholder="@@productLabelStockProcessingOrderDetail.textinput.outputQuantity.placeholder"
                          [readOnly]="isUsingInput"
                          [isInvalid]="(submitted && (outputStockOrderForm.get('totalQuantity').invalid || invalidOutputQuantity)) || invalidOutputQuantityForShipment || invalidOutputQuantityTooLargeValue || invalidFormat">
                    <ng-container>
                      <ng-container *ngIf="submitted">
                        <div *ngIf="outputStockOrderForm.get('totalQuantity').errors as errors" class="sc-invalid-feedback">
                          <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.outputQuantity.textinput.error">
                            Quantity is required
                          </div>
                          <div *ngIf="errors.tooSmall as inputQuantity" i18n="@@productLabelStockProcessingOrderDetail.outputQuantityTooSmall.textinput.error">
                            Quantity is too small. The sum of input transactions is {{inputQuantity}}.
                          </div>
                        </div>
                        <div *ngIf="invalidOutputQuantity && !(outputStockOrderForm.get('totalQuantity').errors && outputStockOrderForm.get('totalQuantity').errors.required)"
                             i18n="@@productLabelStockProcessingOrderDetail.outputQuantity.textinput.error.required2" class="sc-invalid-feedback">
                          Quantity is required
                        </div>
                      </ng-container>
                      <div *ngIf="outputQuantityNotInRange"
                           i18n="@@productLabelStockProcessingOrderDetail.outputQuantity.textinput.error.notInExpectedRange"
                           class="sc-warning-feedback">
                        Output quantity not in expected range
                      </div>
                      <div *ngIf="invalidOutputQuantityForShipment" i18n="@@productLabelStockProcessingOrderDetail.outputQuantityDesiredFirst.textinput.error" class="sc-invalid-feedback">
                        Enter the desired output quantity first
                      </div>
                      <div *ngIf="invalidOutputQuantityTooLargeValue" i18n="@@productLabelStockProcessingOrderDetail.invalidOutputQuantityTooLargeValue.textinput.error" class="sc-invalid-feedback">
                        Output quantity is larger than the input quantity
                      </div>
                      <div *ngIf="invalidFormat" i18n="@@productLabelStockProcessingOrderDetail.invalidFormat.textinput.error" class="sc-invalid-feedback">
                        Invalid number format
                      </div>
                    </ng-container>
                  </textinput>
                </div>
                <div class="af-c6 d-flex align-items-end mb-2">
                  <checkbox-input
                          *ngIf="showUseInput"
                          [form]="checkboxUseInputFrom"
                          (onClick)="useInput($event)">
                    <checkbox-input-rich-label
                            i18n="@@productLabelStockProcessingOrderDetail.checkbox.useInput.label">
                      Use input
                    </checkbox-input-rich-label>
                  </checkbox-input>
                  <checkbox-input
                          *ngIf="showClipOrder"
                          [form]="checkboxClipOrderFrom"
                          (onClick)="clipOrder($event)">
                    <checkbox-input-rich-label
                            i18n="@@productLabelStockProcessingOrderDetail.checkbox.clipOrder.label">
                      Clip input quantity
                    </checkbox-input-rich-label>
                  </checkbox-input>
                </div>
              </div>

              <div class="af-row" *ngIf="showDeliveryData">
                <div class="af-c6">
                  <app-datepicker
                          label="Preferred delivery date"
                          i18n-label="@@productLabelStockProcessingOrderDetail.textinput.preferedDeliveryDate.label"
                          [form]="outputStockOrderForm.get('deliveryTime')"
                          [invalid]="submitted && outputStockOrderForm.get('deliveryTime').invalid">
                    <ng-container>
                      <ng-container *ngIf="submitted">
                        <div *ngIf="outputStockOrderForm.get('deliveryTime').errors as errors" class="sc-invalid-feedback">
                          <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.preferedDeliveryDate.textinput.error">
                            Preferred delivery date is required
                          </div>
                        </div>
                      </ng-container>
                    </ng-container>
                  </app-datepicker>
                </div>
              </div>

              <ng-container *ngIf="this.prAction && this.prAction.requiredEvidenceFields">
                <app-stock-processing-order-fields
                        *ngFor="let fieldInfo of this.prAction.requiredEvidenceFields"
                        side="right"
                        [isQuote]="actionType === 'SHIPMENT'"
                        [fieldInfo]="fieldInfo"
                        [formGroup]="requiredProcEvidenceFieldsForm"
                        [submitted]="submitted">
                </app-stock-processing-order-fields>
              </ng-container>

              <!-- FILED FOR PROVIDING GENERAL COMMENT (PRESENT ALWAYS) -->
              <div class="af-row">
                <div class="af-c12">
                  <textinput
                          [form]="outputStockOrderForm.get('comments')"
                          label="Comments"
                          style="width: 100%"
                          [textarea]="true"
                          i18n-label="@@productLabelStockProcessingOrderDetail.textinput.comments.label">
                  </textinput>
                </div>
              </div>

              <!-- OUTPUT STOCK ORDER (SHOWN IF MULTIPLE OUTPUT STOCK ORDERS ARE PRESENT) -->
              <ng-container *ngIf="outputStockOrders.length > 0">
                <div class="af-row" style="margin-top: 1rem;">
                  <div class="af-c9">
                    <label i18n="@@productLabelStockProcessingOrderDetail.outputStockOrders.outputs.label">Outputs</label>
                  </div>

                  <div class="af-c3 text-right">
                    <button class="btn btn-solid round mr-2"
                            (click)="prefillOutputStockOrdersQuantities()"
                            i18n="@@productLabelStockProcessingOrderDetail.outputStockOrders.prefill">
                      <span>Prefill</span>
                    </button>
                    <button class="btn btn-solid round"
                            (click)="addOutputStockOrder()"
                            i18n="@@productLabelStockProcessingOrderDetail.outputStockOrders.add">
                      <span>+</span>
                    </button>
                  </div>
                </div>
              </ng-container>

              <!-- LIST OF OUTPPUT STOCK ORDERS -->
              <ng-container *ngFor="let item of outputStockOrders.controls; index as idx">
                <div class="af-row">
                  <div class="af-c12">
                    <div class="row">
                      <div class="col-3">
                        <textinput
                                [form]="item.get('sacNumber')"
                                type="number"
                                min="0"
                                step="1"
                                i18n-label="@@productLabelStockProcessingOrderDetail.textinput.sacNumber"
                                label="Sac number"
                                [isInvalid]="submitted && item.get('sacNumber').invalid">
                          <ng-container *ngIf="submitted">
                            <div *ngIf="item.get('sacNumber').errors as errors" class="sc-invalid-feedback">
                              <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.textinput.sacNumber.required.error">
                                Sac number is required
                              </div>
                            </div>
                          </ng-container>
                        </textinput>
                      </div>

                      <div class="col-8">
                        <textinput
                                [form]="item.get('totalQuantity')"
                                i18n-label="@@productLabelStockProcessingOrderDetail.textinput.sacTotalQuantity"
                                [label]="sacNetWLabel"
                                [isInvalid]="submitted && item.get('totalQuantity').invalid">
                          <ng-container *ngIf="submitted">
                            <div *ngIf="item.get('totalQuantity').errors as errors" class="sc-invalid-feedback">
                              <div *ngIf="errors.max" i18n="@@productLabelStockProcessingOrderDetail.textinput.quantity.max.error">
                                Input exceeds the max value
                              </div>
                              <div *ngIf="errors.max" i18n="@@productLabelStockProcessingOrderDetail.textinput.quantity.min.error">
                                Input is too small. Stock order is already partially used.
                              </div>
                            </div>
                          </ng-container>
                        </textinput>
                      </div>

                      <div class="col-1">
                        <div style="margin-top: 1.75rem; cursor: pointer" (click)="removeOutputStockOrder(idx)">
                          <fa-icon
                                  class="del-icon"
                                  [icon]="faTrashAlt">
                          </fa-icon>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </ng-container>

              <!-- VALIDATION MESSAGE -->
              <ng-container *ngIf="submitted && this.outputStockOrders.value.length > 0">
                <div *ngIf="outputStockOrders.errors as errors" class="sc-invalid-feedback"
                     i18n="@@productLabelStockProcessingOrderDetail.outputs.atLeastOne.error">
                  At least one non-empty field is required
                </div>
              </ng-container>

              <div *ngIf="!showRightSide" style="position: absolute; top:0; bottom: 0; left: 0; right: 0; background-color: white; opacity: 0.5;"></div>

            </ng-container>
          </div>
        </div>
      </div>

      <!-- REQUIRED AND OTHER ADDITIONAL PROCESSING EVIDENCES -->
      <div class="af-form-row">
        <div class="af-form-block--c12">
          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.processingEvidence">Processing evidence</h2>

          <div class="af-form-element">
            <div *ngIf="this.requiredProcessingEvidenceArray.length > 0" class="mb-3">
              <ng-container *ngFor="let item of requiredProcessingEvidenceArray.controls; index as idx">
                <div class="d-flex">

                  <div class="af-row">
                    <div class="af-c4">
                      <app-datepicker
                              label="Date"
                              i18n-label="@@processingEvidenceItem.datepicker.date.label"
                              [form]="item.get('date')"
                              [invalid]="submitted && item.get('date').invalid">
                        <ng-container *ngIf="submitted">
                          <div *ngIf="item.get('date').errors as errors" class="sc-invalid-feedback">
                            <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.date.error">
                              Date is required
                            </div>
                          </div>
                        </ng-container>
                      </app-datepicker>
                    </div>
                    <div class="af-c8">
                      <textinput
                              [value]="item.get('evidenceTypeLabel').value"
                              label="Type"
                              [valueTextInput]="true"
                              i18n-label="@@productLabelStockProcessingOrderDetail.label.type"
                              [readOnly]="true">
                      </textinput>
                    </div>
                  </div>

                  <div class="af-c6">
                    <attachment-uploader
                            allowedMimeType="[image/png', 'image/jpeg', 'application/pdf']"
                            allowedMimeTypeErrorMessage="Upload only file types: PNG, JPG and JPEG."
                            mode="simpleAsTextField"
                            label="Document (JPG, PNG, PDF)"
                            i18n-label="@@productLabelStockProcessingOrderDetail.attachment-uploader.label"
                            i18n-allowedMimeTypeErrorMessage="@@productLabelStockProcessingOrderDetail.attachment-uploader.allowedMimeTypeErrorMessage"
                            [form]="item.get('document')"
                            [attachmentUploaderId]="'productLabelStockProcessingOrderDetail'+idx"
                            [invalid]="submitted && item.get('document').invalid"
                            [readOnly]="item.get('document').disabled">
                      <attachment-uploader-content i18n="@@productLabelStockProcessingOrderDetail.attachment-uploader.content">
                        Upload document
                      </attachment-uploader-content>
                    </attachment-uploader>
                    <attachment-uploader-errors>
                      <ng-container *ngIf="submitted">
                        <div *ngIf="item.get('document').errors as errors" validation-error class="sc-invalid-feedback">
                          <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.attachment-uploader.error">
                              <span>
                                Document is required
                              </span>
                          </div>
                        </div>
                      </ng-container>
                    </attachment-uploader-errors>
                  </div>

                </div>
              </ng-container>
            </div>

            <list-editor *ngIf="processingEvidenceListManager"
                         label="Other evidence documents"
                         [listEditorManager]="processingEvidenceListManager"
                         addText="Add document"
                         [canAdd]="showRightSide"
                         i18n-label="@@productLabelStockProcessingOrderDetail.list-editor.processingEvidence.label"
                         i18n-addText="@@productLabelStockProcessingOrderDetail.list-editor.processingEvidence.addText">
              <list-editor-items>
                <div *ngFor="let item of otherProcessingEvidenceArray.controls; let i=index;">
                  <app-additional-proof-item title="null"
                                             [evidenceType]="true"
                                             [formControlInput]="item"
                                             [isOpen]="processingEvidenceListManager.isOpen(i)"
                                             [listEditorManager]="this.processingEvidenceListManager"
                                             [listEditorManagerPosition]="i">
                  </app-additional-proof-item>
                </div>
              </list-editor-items>
              <list-editor-errors>
              </list-editor-errors>
            </list-editor>

          </div>
        </div>
      </div>

      <!-- CERTIFICATES AND STANDARDS -->
      <ng-container *ngIf="showCertificatesIds">
        <div class="af-form-row">
          <div class="af-form-block--c12">
            <h2 i18n="@@productLabelStockProcessingOrderDetail.section.certificationId">Certificates</h2>

            <div class="af-form-element">
              <list-editor
                      label="Certificates"
                      [listEditorManager]="certificationListManager"
                      addText="Add document"
                      [canAdd]="false"
                      i18n-label="@@productLabelStockProcessingOrderDetail.section.certificationId.label"
                      i18n-addText="@@productLabelStockProcessingOrderDetail.section.certificationId.addText">
                <list-editor-items>
                  <div *ngFor="let item of stockOrderCertificatedForm?.controls; let i=index;">
                    <app-certification-and-standard-item
                            title="Certification"
                            i18n-title="@@roductLabelStockProcessingOrderDetail.section.certificationId.title"
                            [formControlInput]="item"
                            [isOpen]="certificationListManager.isOpen(i)"
                            [listEditorManager]="this.certificationListManager"
                            [listEditorManagerPosition]="i">
                    </app-certification-and-standard-item>
                  </div>
                </list-editor-items>
                <list-editor-errors>
                </list-editor-errors>
              </list-editor>
            </div>

          </div>
        </div>
      </ng-container>

      <!-- CONTROL BUTTONS -->
      <div class="af-form-row">
        <div class="af-form-block--c12">
          <div class="af-bottom-buttons" i18n="@@productLabelStockProcessingOrderDetail.footer.buttons">
            <button class="btn btn-outlined mr-2" data-dismiss="modal" type="button" (click)="dismiss()"><span>Cancel</span></button>
            <button class="btn" type="button" (click)="!this.saveProcessingOrderInProgress && saveProcessingOrder()"><span>Save</span></button>
          </div>
        </div>
      </div>

    </div>
  </div>
</app-authorised-layout>
