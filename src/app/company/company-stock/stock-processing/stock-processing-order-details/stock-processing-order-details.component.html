<app-authorised-layout>
  <div *ngIf="procOrderGroup" class="af-layout--authorised">
    <div class="af-form-wrapper">

      <!-- PAGE TITLE - SET DYNAMICALLY DEPENDING ON THE SELECTED PROCESSING ACTION TYPE -->
      <div class="af-form-row">
        <div class="af-form-block--c12 d-flex justify-content-between">
          <div class="title-page content-element--title">{{ title }}<span></span></div>
        </div>
      </div>

      <!-- DISPLAY THE SELECTED PROCESSING ACTION AND FINAL PRODUCT NAME IF ACTION IS QR CODE GENERATION -->
      <div class="af-form-row">
        <div class="af-form-block--c6">
          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.processing">Choose activity that you want to record</h2>
          <div class="af-form-element">

            <!-- DROPDOWN FOR SELECTING PROCESSING ACTION (IF ID PRESENT IN PATH, SELECTED AUTOMATICALLY) -->
            <div class="af-row">
              <div class="af-c12">
                <single-choice
                    label="Processing"
                    i18n-label="@@productLabelStockProcessingOrderDetail.processingActionForm.label"
                    [formControlInput]="$any(procOrderGroup.get('processingAction'))"
                    [codebookService]="procActionsCodebook"
                    style="min-width: 150px;"
                    (onChange)="processingActionUpdated($event)"
                    [isInvalidChoice]="submitted && procOrderGroup.get('processingAction').invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="procOrderGroup.get('processingAction').errors as errors" class="sc-invalid-feedback"
                         i18n="@@productLabelStockProcessingOrderDetail.processingActionForm.error">
                      Action is required
                    </div>
                  </ng-container>
                </single-choice>
              </div>
            </div>

            <!-- IF ACTION IS FOR QR CODE GENERATION, DISPLAY THE FINAL PRODUCT NAME -->
            <div class="af-row" *ngIf="actionType === 'GENERATE_QR_CODE'">
              <div class="af-c12">
                <textinput
                    [form]="qrCodeForFinalProductControl"
                    label="QR code for final product"
                    i18n-label="@@productLabelStockProcessingOrderDetail.qrCodeForFinalProduct.label"
                    style="width: 100%">
                </textinput>
              </div>
            </div>

          </div>
        </div>

        <div *ngIf="selectedProcAction" class="af-form-block--c6">
          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.output.commonFieldsSectionTitle">Results of recording</h2>
          <div class="af-form-element position-relative outputs-bottom-spacing">

            <!-- ON QUOTE ORDERS - SHIPMENT, DISPLAY THE COMPANY NAME THAT IS CREATING THE ORDER -->
            <div class="af-row mb-3" *ngIf="actionType === 'SHIPMENT' && quoteOrderOwnerCompany">
              <div class="af-c12">
                {{ quoteOrderOwnerCompany }}
              </div>
            </div>

            <!-- ON QUOTE ORDERS - SHIPMENT, DISPLAY THE PRODUCT ORDER IF SET; THIS IS APPLICABLE IN QUOTE ORDERS FOR FINAL PRODUCTS -->
            <div class="af-row mb-3" *ngIf="actionType === 'SHIPMENT' && productOrderId">
              <div class="af-c12">
                <span i18n="@@productLabelStockProcessingOrderDetail.orderID.label">Order ID:</span> {{ productOrderId }}
              </div>
            </div>

            <div class="af-row">
              <div class="af-c12">
                <app-datepicker
                    label="Processing date"
                    i18n-label="@@productLabelStockProcessingOrderDetail.datepicker.date.processingDate"
                    [form]="$any(procOrderGroup.get('processingDate'))"
                    [invalid]="submitted && procOrderGroup.get('processingDate').invalid"
                    style="width: 130px; margin-right: 1rem;">
                  <ng-container>
                    <div *ngIf="procOrderGroup.get('processingDate').errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.processingDate.error">
                        Processing date is required
                      </div>
                    </div>
                  </ng-container>
                </app-datepicker>
              </div>
            </div>

            <div *ngIf="!rightSideEnabled" class="disabled-section-overlay"></div>
          </div>
        </div>
      </div>

      <!-- SECTION WHERE WE DISPLAY THE INPUT AND OUTPUT DATA FOR THE PROCESSING -->
      <!-- THE LEFT REPRESENTS THE INPUT PARAMETERS, AND THE RIGHT SIDE REPRESENTS THE OUTPUTS (THERE CAN BE MORE THAN ONE OUTPUT FROM THE PROCESSING) -->
      <div class="af-form-row">

        <!-- LEFT SIDE - input data in the processing -->
        <div *ngIf="selectedProcAction" class="af-form-block--c6">

          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.input">Material to be recorded</h2>
          <div class="af-form-element position-relative">
            <div class="af-row mb-3" *ngIf="actionType === 'SHIPMENT'">
              <div class="af-c12">
                {{ inputFacilityControl?.value?.company?.name }}
              </div>
            </div>

            <!-- INPUT FACILITY SELECTION DROPDOWN -->
            <div class="af-row">
              <div class="af-c12">
                <single-choice
                        *ngIf="inputFacilitiesCodebook"
                        label="Facility"
                        i18n-label="@@productLabelStockProcessingOrderDetail.inputFacilityForm.label"
                        [formControlInput]="inputFacilityControl"
                        [codebookService]="inputFacilitiesCodebook"
                        style="min-width: 150px;"
                        (onChange)="setInputFacility($event)"
                        [isInvalidChoice]="submitted && inputFacilityControl.invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="inputFacilityControl.errors as errors"
                         class="sc-invalid-feedback" i18n="@@productLabelStockProcessingOrderDetail.inputFacilityForm.error">
                      Input facility is required
                    </div>
                  </ng-container>
                </single-choice>
              </div>
            </div>

            <!-- DATE AND INTERNAL LOT NAME SEARCH FOR AVAILABLE STOCK AT SELECTED FACILITY FOR THE SELECTED SEMI-PRODUCT -->
            <div *ngIf="inputFacilityControl.value" class="d-flex justify-content-between"
                 ngbDropdown placement="bottom-right" display="dynamic" container="body">

              <div class="af-row">
                <div class="af-c12">
                  <div class="d-flex">

                    <app-datepicker
                            label="From"
                            i18n-label="@@productLabelStockProcessingOrderDetail.datepicker.date.from"
                            [form]="dateFromFilterControl"
                            [invalid]="submitted && dateFromFilterControl.invalid"
                            style="width: 130px; margin-right: 1rem;"
                            (onChange)="dateSearch()">
                      <ng-container>
                        <div *ngIf="dateFromFilterControl.errors as errors" class="sc-invalid-feedback">
                          <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.date.error">
                            Delivery date is required
                          </div>
                        </div>
                      </ng-container>
                    </app-datepicker>

                    <app-datepicker
                            label="To"
                            i18n-label="@@productLabelStockProcessingOrderDetail.datepicker.date.to"
                            [form]="dateToFilterControl"
                            [invalid]="submitted && dateToFilterControl.invalid"
                            style="width: 130px"
                            (onChange)="dateSearch()">
                      <ng-container>
                        <div *ngIf="dateToFilterControl.errors as errors" class="sc-invalid-feedback">
                          <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.date.error">
                            Delivery date is required
                          </div>
                        </div>
                      </ng-container>
                    </app-datepicker>

                  </div>
                </div>
              </div>

              <div class="d-flex">
                <app-search-textinput [form]="internalLotNameSearchControl" style="margin-top: 1.55rem;">
                </app-search-textinput>
              </div>
            </div>

            <!-- ORGANIC AND WOMEN'S COFFE FILTERS DROPDOWN -->
            <div *ngIf="inputFacilityControl.value"
                 class="d-flex justify-content-end" ngbDropdown placement="bottom-right" display="dynamic" container="body">
              <div *ngIf="womenOnlyFilterControl.value != null" (click)="setWomenOnlyStatus(null)"
                   class="d-flex filter-text cursor-pointer" style="margin-top: 0.55rem;"> {{ womenOnlyStatusValue }}
                <div style="margin-left: 0.5rem;">
                  <fa-icon [icon]="faTimes" size="xs"></fa-icon>
                </div>
              </div>
              <div *ngIf="organicOnlyFilterControl.value != null" (click)="setOrganicOnlyStatus(null)"
                   class="d-flex filter-text cursor-pointer" style="margin-left: 1rem; margin-top: 0.55rem;"> {{ organicOnlyStatusValue }}
                <div style="margin-left: 0.5rem;">
                  <fa-icon [icon]="faTimes" size="xs"></fa-icon>
                </div>
              </div>

              <button ngbDropdownToggle class="btn btn-filter" style="margin-left: 1rem;">
                  <span class="button-icon">
                    <span class="button-icon-shape button-icon-shape--filter"></span>
                  </span>
                <span i18n="@@productLabelStockProcessingOrderDetail.filter" class="button-icon-label">Filter</span>
              </button>

              <div class="dropdown-menu" ngbDropdownMenu>
                <button ngbDropdownItem (click)="setWomenOnlyStatus(true)" i18n="@@productLabelStockProcessingOrderDetail.filter.womensOnlyCoffee">Women's only coffee</button>
                <button ngbDropdownItem (click)="setWomenOnlyStatus(false)" i18n="@@productLabelStockProcessingOrderDetail.filter.nonWomensOnlyCoffee">Non-women's only coffee</button>
                <div class="line"></div>
                <button ngbDropdownItem (click)="setOrganicOnlyStatus(true)" i18n="@@productLabelStockProcessingOrderDetail.filter.organicOnlyCoffee">Organic only coffee</button>
                <button ngbDropdownItem (click)="setOrganicOnlyStatus(false)" i18n="@@productLabelStockProcessingOrderDetail.filter.nonOrganicOnlyCoffee">Non-organic only coffee</button>
              </div>
            </div>

            <!-- EXISTING INPUT TRANSACTIONS AND AVAIALBLE STOCK ORDERS THAT CAN BE ADDED TO THIS PROECSSING ORDER -->
            <div *ngIf="inputFacilityControl.value">

              <!-- Existing input transactions - only applicable when editing stock order -->
              <div class="af-row">
                <div class="af-c12">
                  <ng-container *ngIf="inputTransactions && inputTransactions.length">
                    <label class="ml-1">Existing transactions</label>
                    <div *ngFor="let tx of inputTransactions; index as i" class="af-row pb-2">
                      <div class="af-c9 pl-3">
                        <div>
                          <span>{{ tx.sourceStockOrder.lotPrefix }} {{ tx.sourceStockOrder.identifier }} {{ tx.sourceStockOrder.internalLotNumber }} ({{ tx.status }})</span>
                          <span *ngIf="tx.sourceStockOrder.qrCodeTag"
                                (click)="openInputStockOrderQRCode(tx.sourceStockOrder)"
                                class="cursor-pointer">
                            <fa-icon [icon]="faQrcode" class="sorter-icon pl-2"></fa-icon>
                          </span>
                          <span *ngIf="tx.sourceStockOrder.organic">
                            <fa-icon [icon]="faLeaf" class="sorter-icon pl-2" title="Organic coffee"
                                     i18n-title="@@productLabelStockProcessingOrderDetail.icon.organicCoffee.title"></fa-icon>
                          </span>
                          <span *ngIf="tx.sourceStockOrder.womenShare">
                            <fa-icon [icon]="faFemale" class="sorter-icon pl-2" title="Women's coffee"
                                     i18n-title="@@productLabelStockProcessingOrderDetail.icon.womensCoffee.title"></fa-icon>
                          </span>
                        </div>
                        <div *ngIf="tx.status === 'CANCELED'" class="canceled">{{ tx.rejectComment }}</div>
                      </div>
                      <div class="af-c2 text-right">{{ tx.outputQuantity }} {{ tx.inputMeasureUnitType?.label }}</div>

                      <div class="af-c1 text-right"
                           [hidden]="tx.status !== 'PENDING'"
                           (click)="deleteTransaction(i)">
                        <fa-icon
                                class="del-icon cursor-pointer"
                                [icon]="faTimes"></fa-icon>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>

              <!-- WRAPPER FOR AVAILABLE STOCK ORDER SECTION (we use this so we can overlay when controls should be disabled) -->
              <div class="position-relative">

                <!-- CHECKBOX FOR SELECTING ALL INPUT AVAILABLE STOCK ORDERS -->
                <div class="af-row" *ngIf="inputFacilityControl.value && availableInputStockOrders.length > 0">
                  <label i18n="@@productLabelStockProcessingOrderDetail.addNewTransactions" class="ml-1 mt-2">Add new transactions</label>
                  <div class="af-c12" style="margin-top: -1rem;">
                    <checkbox-input (onClick)="cbSelectAllClick()" [form]="cbSelectAllControl" style="margin-bottom: 1rem; margin-top: -1rem;">
                      <checkbox-input-rich-label i18n="@@productLabelStockProcessingOrderDetail.checkbox.selectAll">
                        Select all ({{ currentInputStockUnit.name }})
                      </checkbox-input-rich-label>
                    </checkbox-input>
                  </div>
                </div>
                <div class="af-row" *ngIf="inputFacilityControl.value && availableInputStockOrders.length === 0">
                  <label class="ml-1 mt-2" i18n="@@productLabelStockProcessingOrderDetail.noStock">No relevant stock to add transactions in facility</label>
                </div>

                <!-- LIST OF AVAILABLE STOCK ORDERS TO BE USED IN THE PROCESSING ACTION -->
                <ng-container *ngFor="let item of availableInputStockOrders; index as i">
                  <div class="af-row">
                    <div class="af-c1">
                      <checkbox-input inTable="true" (onClick)="cbSelectClick(item, i)"
                                      [checked]="this.availableInputStockOrders[i].selected"></checkbox-input>
                    </div>
                    <div class="af-c8">
                      <ng-container *ngIf="item.orderType === 'PURCHASE_ORDER'">
                        <span>{{ item.identifier }} ({{ item.producerUserCustomer.name }} {{ item.producerUserCustomer.surname }})</span>
                      </ng-container>
                      <ng-container *ngIf="item.orderType != 'PURCHASE_ORDER'">
                        <span>{{ item.lotPrefix }} {{ item.identifier }} {{ item.internalLotNumber }}</span>
                        <span *ngIf="item.qrCodeTag"
                              (click)="openInputStockOrderQRCode(item)"
                              class="cursor-pointer">
                        <fa-icon [icon]="faQrcode" class="sorter-icon pl-2"></fa-icon>
                      </span>
                      </ng-container>
                      <span *ngIf="item.organic">
                      <fa-icon [icon]="faLeaf" class="sorter-icon pl-2" title="Organic coffee"
                               i18n-title="@@productLabelStockProcessingOrderDetail.icon.organicCoffee.title"></fa-icon>
                    </span>
                      <span *ngIf="item.womenShare">
                      <fa-icon [icon]="faFemale" class="sorter-icon pl-2" title="Women's coffee"
                               i18n-title="@@productLabelStockProcessingOrderDetail.icon.womensCoffee.title"></fa-icon>
                    </span>
                    </div>
                    <div class="af-c3 text-right">
                    <span *ngIf="actionType === 'PROCESSING' || actionType === 'FINAL_PROCESSING'"
                          (click)="clipInputTransaction(item, i)" class="cursor-pointer">
                      <fa-icon [icon]="faCut" class="pr-2"></fa-icon>
                    </span>
                      <span *ngIf="item.selected">{{ item.selectedQuantity }} / </span>{{ item.availableQuantity }} {{ currentInputStockUnit.measurementUnitType.label }}
                    </div>
                  </div>
                </ng-container>

                <div *ngIf="disabledLeftFields && leftSideEnabled" class="disabled-section-overlay"></div>
              </div>

              <ng-container *ngIf="submitted && oneInputStockOrderRequired">
                <small class="sc-invalid-feedback" i18n="@@productLabelStockProcessingOrderDetail.inputSemiProducts.error">
                  At least one input semi-product is required
                </small>
              </ng-container>
            </div>

            <div *ngIf="!leftSideEnabled" class="disabled-section-overlay"></div>
          </div>
        </div>

        <!-- RIGHT SIDE - OUTPUT DATA OF THE PROCESSING -->
        <div *ngIf="selectedProcAction" class="af-form-block--c6">

          <h3 i18n="@@productLabelStockProcessingOrderDetail.section.output.outputsSectionTitle">Outputs of this processing</h3>
          <div class="af-form-element position-relative outputs-bottom-spacing"
               *ngFor="let tsoGroup of targetStockOrdersArray.controls; index as i">

            <!-- CONTROLS FOR DISPLAYING AND SELECTING OUTPUT STOCK UNIT -->
            <div class="af-row">

              <!-- HANDLE CASE WHEN WE HAVE OUTPUT FINAL PRODUCT INSTEAD OF OUTPUT SEMI-PRODUCTS -->
              <ng-container *ngIf="currentOutputFinalProduct; else outputSemiProduct">
                <div class="af-c12">
                  <textinput
                      [form]="outputFinalProductNameControl"
                      label="Final product type"
                      i18n-label="@@productLabelStockProcessingOrderDetail.textinput.finalProductType.label"
                      style="width: 100%">
                  </textinput>
                </div>
              </ng-container>
              <ng-template #outputSemiProduct>
                <div class="af-c12 d-flex">
                  <div class="flex-fill">
                    <single-choice
                            label="Semi-product type"
                            i18n-label="@@productLabelStockProcessingOrderDetail.outputsSemiProductForm.label"
                            [formControlInput]="$any(tsoGroup.get('semiProduct'))"
                            [codebookService]="outputSemiProductsCodebook"
                            [clearable]="false"
                            style="min-width: 150px;"
                            [isInvalidChoice]="submitted && tsoGroup.get('semiProduct').invalid">
                      <ng-container *ngIf="submitted">
                        <div *ngIf="tsoGroup.get('semiProduct').errors as errors" class="sc-invalid-feedback"
                             i18n="@@productLabelStockProcessingOrderDetail.outputsSemiProductForm.error">
                          Output Semi-product is required
                        </div>
                      </ng-container>
                    </single-choice>
                  </div>
                  <div class="ml-4">
                    <div class="delete-output-icon"
                         [class.disabled]="targetStockOrdersArray.length < 2"
                         (click)="removeOutput(i)">
                      <fa-icon class="del-icon" [icon]="faTrashAlt"></fa-icon>
                    </div>
                  </div>
                </div>
              </ng-template>

            </div>

            <!-- CONTROLS FOR SELECTING OUTPUT FACILITY -->
            <div class="af-row">
              <div class="af-c12">
                <single-choice
                    *ngIf="currentOutputFinalProduct || tsoGroup.get('semiProduct').value"
                    label="Facility"
                    i18n-label="@@productLabelStockProcessingOrderDetail.outputFacilityForm.label"
                    [formControlInput]="$any(tsoGroup.get('facility'))"
                    [codebookService]="getOutputFacilityCodebook($any(tsoGroup))"
                    [clearable]="false"
                    style="min-width: 150px;"
                    [isInvalidChoice]="submitted && tsoGroup.get('facility').invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="tsoGroup.get('facility').errors as errors" class="sc-invalid-feedback"
                         i18n="@@productLabelStockProcessingOrderDetail.outputFacilityForm.error">
                      Output facility is required
                    </div>
                  </ng-container>
                </single-choice>
              </div>
            </div>

            <!-- THE USER ENTERED ORDER ID - RELEVANT FOR QUOTE ORDER AND CAN BE SET ONLY WHEN NO PRODUCT ORDER IS PRESENT -->
            <div class="af-row" *ngIf="actionType === 'SHIPMENT' && !productOrderId">
              <div class="af-c12">
                <textinput
                    [form]="$any(tsoGroup.get('orderId'))"
                    label="Order ID"
                    placeholder="Enter the order ID"
                    style="width: 100%"
                    i18n-label="@@productLabelStockProcessingOrderDetail.textinput.orderId.label"
                    i18n-placeholder="productLabelStockProcessingOrderDetail.textinput.orderId.placeholder">
                </textinput>
              </div>
            </div>

            <!-- THE INTERNAL LOT NUMBER -->
            <div class="af-row">
              <div class="af-c3">
                <textinput
                    [form]="procActionLotPrefixControl"
                    label="Prefix"
                    style="width: 100%"
                    i18n-label="@@productLabelStockProcessingOrderDetail.textinput.lotPrefix.label">
                </textinput>
              </div>
              <div class="af-c9">
                <textinput
                    [form]="$any(tsoGroup.get('internalLotNumber'))"
                    label="Internal lot name"
                    style="width: 100%"
                    placeholder="Enter internal lot name"
                    i18n-label="@@productLabelStockProcessingOrderDetail.textinput.internalLotNumber.label"
                    i18n-placeholder="@@productLabelStockProcessingOrderDetail.textinput.internalLotNumber.placeholder"
                    [isInvalid]="submitted && tsoGroup.get('internalLotNumber').invalid">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="tsoGroup.get('internalLotNumber').errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.internalLotNumber.textinput.error">
                        Internal lot name is required
                      </div>
                    </div>
                  </ng-container>
                </textinput>
              </div>
            </div>

            <!-- FORM CONTROLS FOR DEFINING OUTPUT QUANTITY -->
            <div *ngIf="actionType !== 'TRANSFER' && actionType !== 'GENERATE_QR_CODE'" class="af-row">
              <div class="af-c6">
                <textinput
                    [form]="$any(tsoGroup.get('totalQuantity'))"
                    label="{{ targetStockOrderOutputQuantityLabel + ' ' + (tsoGroup.get('measureUnitType')?.value ? tsoGroup.get('measureUnitType').value.label : '-') }}"
                    style="width: 100%"
                    placeholder="Enter quantity"
                    i18n-placeholder="@@productLabelStockProcessingOrderDetail.textinput.outputQuantity.placeholder">
                  <ng-container *ngIf="submitted">
                    <div *ngIf="tsoGroup.get('totalQuantity').errors as errors" class="sc-invalid-feedback">
                      <div *ngIf="errors.required">
                        <span *ngIf="actionType != 'SHIPMENT'; else quoteQuantityRequired"
                              i18n="@@productLabelStockProcessingOrderDetail.outputQuantity.textinput.error.required">Quantity is required</span>
                        <ng-template #quoteQuantityRequired>
                          <span i18n="@@productLabelStockProcessingOrderDetail.outputQuantity.textinput.error.requiredOnQuote">Enter the desired output quantity</span>
                        </ng-template>
                      </div>
                    </div>
                  </ng-container>
                </textinput>
              </div>
            </div>

            <!-- IF PROCESSING ACTION IS OF TYPE 'SHIPMENT' SHOW CONTROL FOR DELIVERY TIME -->
            <div class="af-row" *ngIf="actionType === 'SHIPMENT'">
              <div class="af-c6">
                <app-datepicker
                    label="Preferred delivery date"
                    i18n-label="@@productLabelStockProcessingOrderDetail.textinput.preferedDeliveryDate.label"
                    [form]="tsoGroup.get('deliveryTime')"
                    [invalid]="submitted && tsoGroup.get('deliveryTime').invalid">
                  <ng-container>
                    <ng-container *ngIf="submitted">
                      <div *ngIf="tsoGroup.get('deliveryTime').errors as errors" class="sc-invalid-feedback">
                        <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.preferedDeliveryDate.textinput.error">
                          Preferred delivery date is required
                        </div>
                      </div>
                    </ng-container>
                  </ng-container>
                </app-datepicker>
              </div>
            </div>

            <!-- DISPLAY THE PROCESSING EVIDENCE FIELDS -->
            <ng-container *ngIf="selectedProcAction.requiredEvidenceFields">
              <app-stock-processing-order-fields
                  *ngFor="let fieldInfo of selectedProcAction.requiredEvidenceFields"
                  side="right"
                  [isQuote]="actionType === 'SHIPMENT'"
                  [fieldInfo]="fieldInfo"
                  [formGroup]="$any(tsoGroup.get('requiredProcEvidenceFieldGroup'))"
                  [submitted]="submitted">
              </app-stock-processing-order-fields>
            </ng-container>

            <!-- IF THE PROCESSING ACTION HAS SET 'repackedOutputs', DISPLAY LIST OF OUTPUT STOCK ORDERS -->
            <ng-container *ngIf="selectedProcAction.repackedOutputs && repackedOutputStockOrdersArray.length > 0">
              <div class="af-row mt-4">
                <div class="af-c9">
                  <label i18n="@@productLabelStockProcessingOrderDetail.outputStockOrders.outputs.label">Outputs</label>
                </div>

                <div class="af-c3 text-right">
                  <button class="btn btn-solid round mr-2"
                          (click)="prefillRepackedOutputSOQuantities()"
                          i18n="@@productLabelStockProcessingOrderDetail.outputStockOrders.prefill">
                    <span>Prefill</span>
                  </button>
                  <button class="btn btn-solid round"
                          (click)="addRepackedOutputStockOrder()"
                          i18n="@@productLabelStockProcessingOrderDetail.outputStockOrders.add">
                    <span>+</span>
                  </button>
                </div>
              </div>

              <div *ngFor="let item of repackedOutputStockOrdersArray.controls; index as idx" class="af-row">
                <div class="af-c12">
                  <div class="row">
                    <span>Test</span>
                    <!-- TODO: generated repacked output stock orders -->
                  </div>
                </div>
              </div>
            </ng-container>

            <div *ngIf="!rightSideEnabled" class="disabled-section-overlay"></div>
          </div>

          <div *ngIf="showAddNewOutputButton" class="d-flex justify-content-end outputs-bottom-spacing">
            <button class="btn" type="button" (click)="addNewOutput()">
              <span>Add additional output</span>
            </button>
          </div>

          <h3 i18n="@@productLabelStockProcessingOrderDetail.section.output.totalQuantitiesSectionTitle">Total quantities</h3>
          <div class="af-form-element position-relative">

            <!-- DISPLAY THE TOTAL SELECTED INPUT QUANTITY - EXISTING INPUT TRANSACTIONS AND SELECTED INPUT STOCK ORDERS -->
            <div class="af-row">
              <div class="af-c6">
                <textinput
                        [form]="totalInputQuantityControl"
                        [label]="inputQuantityLabel"
                        style="width: 100%">
                </textinput>
              </div>

              <!-- DISPLAY THE DIFFERENCE QUANTITY BETWEEN THE TOTAL INPUT AND THE TOTAL (ENTERED IN TARGET STOCK ORDERS) OUTPUT -->
              <div class="af-c6" *ngIf="actionType !== 'TRANSFER' && actionType !== 'GENERATE_QR_CODE'">
                <textinput
                        [form]="remainingQuantityControl"
                        [label]="remainingQuantityLabel"
                        style="width: 100%">
                </textinput>
              </div>
            </div>

            <!-- DISPLAY THE TOTAL OUTPUT QUANTITY - SUM OF TOTAL QUANTITY ENTERED FOR EVERY TARGET STOCK ORDER -->
            <div *ngIf="actionType !== 'TRANSFER' && actionType !== 'GENERATE_QR_CODE'" class="af-row">
              <div class="af-c12">
                <textinput
                        [form]="totalOutputQuantityControl"
                        [label]="totalOutputQuantityLabel"
                        [helpText]="expectedOutputQuantityHelpText"
                        style="width: 100%">
                  <div *ngIf="totalOutputQuantityTooLarge"
                       i18n="@@productLabelStockProcessingOrderDetail.totalOutputQuantity.textinput.error.quantityTooLarge"
                       class="sc-warning-feedback">
                    Output quantity exceeds input quantity. Would you like to proceed?
                  </div>
                  <div *ngIf="outputQuantityNotInRange"
                       i18n="@@productLabelStockProcessingOrderDetail.outputQuantity.textinput.error.notInExpectedRange"
                       class="sc-warning-feedback">
                    Output quantity not in expected range
                  </div>
                </textinput>
              </div>
            </div>

            <!-- FILED FOR PROVIDING GENERAL COMMENT (PRESENT ALWAYS) -->
            <div class="af-row">
              <div class="af-c12">
                <textinput
                    [form]="commentsControl"
                    label="Comments"
                    style="width: 100%"
                    [textarea]="true"
                    i18n-label="@@productLabelStockProcessingOrderDetail.textinput.comments.label">
                </textinput>
              </div>
            </div>

            <div *ngIf="!rightSideEnabled" class="disabled-section-overlay"></div>
          </div>

        </div>
      </div>

      <!-- REQUIRED AND OTHER ADDITIONAL PROCESSING EVIDENCES (DOCUMENTS) -->
      <div class="af-form-row">
        <div class="af-form-block--c12">
          <h2 i18n="@@productLabelStockProcessingOrderDetail.section.processingEvidence">Processing evidence</h2>

          <div class="af-form-element">
            <div *ngIf="this.requiredProcessingEvidenceArray.length > 0" class="mb-3">
              <ng-container *ngFor="let item of requiredProcessingEvidenceArray.controls; index as idx">
                <div class="d-flex">

                  <div class="af-row">
                    <div class="af-c4">
                      <app-datepicker
                          label="Date"
                          i18n-label="@@processingEvidenceItem.datepicker.date.label"
                          [form]="item.get('date')"
                          [invalid]="submitted && item.get('date').invalid">
                        <ng-container *ngIf="submitted">
                          <div *ngIf="item.get('date').errors as errors" class="sc-invalid-feedback">
                            <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.datepicker.date.error">
                              Date is required
                            </div>
                          </div>
                        </ng-container>
                      </app-datepicker>
                    </div>
                    <div class="af-c8">
                      <textinput
                          [form]="$any(item.get('evidenceTypeLabel'))"
                          label="Type"
                          i18n-label="@@productLabelStockProcessingOrderDetail.label.type">
                      </textinput>
                    </div>
                  </div>

                  <div class="af-c6">
                    <attachment-uploader
                        allowedMimeType="[image/png', 'image/jpeg', 'application/pdf']"
                        allowedMimeTypeErrorMessage="Upload only file types: PNG, JPG and JPEG."
                        mode="simpleAsTextField"
                        label="Document (JPG, PNG, PDF)"
                        i18n-label="@@productLabelStockProcessingOrderDetail.attachment-uploader.label"
                        i18n-allowedMimeTypeErrorMessage="@@productLabelStockProcessingOrderDetail.attachment-uploader.allowedMimeTypeErrorMessage"
                        [form]="$any(item.get('document'))"
                        [attachmentUploaderId]="'productLabelStockProcessingOrderDetail'+idx"
                        [invalid]="submitted && item.get('document').invalid">
                      <attachment-uploader-content i18n="@@productLabelStockProcessingOrderDetail.attachment-uploader.content">
                        Upload document
                      </attachment-uploader-content>
                    </attachment-uploader>
                    <attachment-uploader-errors>
                      <ng-container *ngIf="submitted">
                        <div *ngIf="item.get('document').errors as errors" validation-error class="sc-invalid-feedback">
                          <div *ngIf="errors.required" i18n="@@productLabelStockProcessingOrderDetail.attachment-uploader.error">
                              <span>
                                Document is required
                              </span>
                          </div>
                        </div>
                      </ng-container>
                    </attachment-uploader-errors>
                  </div>

                </div>
              </ng-container>
            </div>

            <list-editor *ngIf="processingEvidenceListManager"
                         label="Other evidence documents"
                         [listEditorManager]="processingEvidenceListManager"
                         addText="Add document"
                         [canAdd]="rightSideEnabled"
                         i18n-label="@@productLabelStockProcessingOrderDetail.list-editor.processingEvidence.label"
                         i18n-addText="@@productLabelStockProcessingOrderDetail.list-editor.processingEvidence.addText">
              <list-editor-items>
                <div *ngFor="let item of otherProcessingEvidenceArray.controls; let i=index;">
                  <app-additional-proof-item title="null"
                                             [evidenceType]="true"
                                             [formControlInput]="$any(item)"
                                             [isOpen]="processingEvidenceListManager.isOpen(i)"
                                             [listEditorManager]="this.processingEvidenceListManager"
                                             [listEditorManagerPosition]="i">
                  </app-additional-proof-item>
                </div>
              </list-editor-items>
              <list-editor-errors>
              </list-editor-errors>
            </list-editor>
          </div>
        </div>
      </div>

      <!-- CONTROL BUTTONS -->
      <div class="af-form-row">
        <div class="af-form-block--c12">
          <div class="af-bottom-buttons" i18n="@@productLabelStockProcessingOrderDetail.footer.buttons">
            <button class="btn btn-outlined mr-2" data-dismiss="modal" type="button" (click)="dismiss()"><span>Cancel</span></button>
            <button class="btn" type="button" (click)="!this.saveInProgress && saveProcessingOrder()"><span>Save</span></button>
          </div>
        </div>
      </div>

    </div>
  </div>
</app-authorised-layout>
